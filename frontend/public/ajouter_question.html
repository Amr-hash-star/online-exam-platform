<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ajouter une question</title>
  <link rel="stylesheet" href="style3.css">
</head>
<body>
  <div class="container">
    <div style="text-align: right;">
      <button id="logoutBtn">Se déconnecter</button>
    </div>

    <h1>Ajouter une question à un examen</h1>

    <label>Examen ID (copie depuis /api/exams ou lien généré) :</label>
    <input type="text" id="examId" required>

    <label>Type de question :</label>
    <select id="type">
      <option value="qcm">QCM</option>
      <option value="directe">Question directe</option>
    </select>

    <label>Énoncé :</label>
    <textarea id="enonce" rows="3"></textarea>

    <label>Ajouter un média :</label>
    <input type="file" id="media">

    <!-- QCM -->
    <div id="qcm-options">
      <label>Options (coche les bonnes réponses) :</label>
      <div id="options-list"></div>
      <button type="button" onclick="ajouterOption()">Ajouter une option</button>
    </div>

    <!-- Directe -->
    <div id="directe-options" class="hidden">
      <label>Réponse attendue :</label>
      <input type="text" id="reponseDirecte">

      <label>Taux de tolérance (en %, ex: 10) :</label>
      <input type="number" id="tolerance" min="0" max="100">
    </div>

    <!-- Commun -->
    <label>Durée (en secondes) :</label>
    <input type="number" id="duree" min="0">

    <label>Note :</label>
    <input type="number" id="note" min="0" step="0.5">

    <button onclick="soumettreQuestion()">Soumettre la question</button>
  </div>

  <script>
    const typeSelect = document.getElementById('type');
    const optionsList = document.getElementById('options-list');
    const qcmOptions = document.getElementById('qcm-options');
    const directeOptions = document.getElementById('directe-options');

    // Affichage conditionnel au changement
    typeSelect.addEventListener('change', () => {
      const isQCM = typeSelect.value === 'qcm';
      qcmOptions.style.display = isQCM ? 'block' : 'none';
      directeOptions.style.display = !isQCM ? 'block' : 'none';
    });

    // Affichage initial selon valeur sélectionnée
    const isQCMInit = typeSelect.value === 'qcm';
    qcmOptions.style.display = isQCMInit ? 'block' : 'none';
    directeOptions.style.display = !isQCMInit ? 'block' : 'none';

    function ajouterOption() {
      const index = optionsList.children.length;
      const div = document.createElement('div');
      div.className = 'option';
      div.innerHTML = `
        <input type="checkbox" class="checkbox" />
        <input type="text" placeholder="Option ${index + 1}" class="option-text"/>
      `;
      optionsList.appendChild(div);
    }

    async function soumettreQuestion() {
      let examIdInput = document.getElementById('examId').value.trim();

      if (examIdInput.startsWith('http')) {
        const code = examIdInput.split('/').pop();
        try {
          const res = await fetch(`http://localhost:5000/api/exams/code/${code}`);
          if (!res.ok) {
            alert("Lien d'examen invalide ou inexistant.");
            return;
          }
          const exam = await res.json();
          examIdInput = exam._id;
        } catch (err) {
          alert("Erreur lors de la récupération de l'examen.");
          console.error(err);
          return;
        }
      }

      if (!/^[0-9a-fA-F]{24}$/.test(examIdInput)) {
        alert("L'ID d'examen semble invalide.");
        return;
      }

      const type = document.getElementById('type').value;
      const enonce = document.getElementById('enonce').value.trim();
      const duree = parseInt(document.getElementById('duree').value) || 0;
      const note = parseFloat(document.getElementById('note').value) || 0;

      if (!enonce) {
        alert("L'énoncé est obligatoire.");
        return;
      }

      const formData = new FormData();
      formData.append('examId', examIdInput);
      formData.append('type', type);
      formData.append('enonce', enonce);
      formData.append('note', note);
      formData.append('duree', duree);

      if (type === 'qcm') {
        const texts = document.querySelectorAll('.option-text');
        const checks = document.querySelectorAll('.checkbox');

        const options = [], bonnesReponses = [];

        texts.forEach((input, i) => {
          const val = input.value.trim();
          if (val) {
            options.push(val);
            if (checks[i].checked) bonnesReponses.push(options.length - 1);
          }
        });

        if (options.length < 2) {
          alert("Un QCM doit contenir au moins 2 options.");
          return;
        }
        if (bonnesReponses.length === 0) {
          alert("Veuillez cocher au moins une bonne réponse.");
          return;
        }

        formData.append('options', JSON.stringify(options));
        formData.append('bonnesReponses', JSON.stringify(bonnesReponses));
      }

      if (type === 'directe') {
        const reponse = document.getElementById('reponseDirecte').value.trim();
        const tolerance = parseFloat(document.getElementById('tolerance').value) || 0;

        if (!reponse) {
          alert("Veuillez entrer la réponse attendue.");
          return;
        }

        formData.append('reponse', reponse);
        formData.append('tolerance', tolerance);
      }

      const mediaFile = document.getElementById('media').files[0];
      if (mediaFile) {
        formData.append('media', mediaFile);
      }

      try {
        const endpoint = type === 'qcm' ? 'qcm' : 'directe';
        const res = await fetch(`http://localhost:5000/api/questions/${endpoint}`, {
          method: 'POST',
          body: formData
        });

        if (res.ok) {
          alert('Question ajoutée avec succès !');
          location.reload();
        } else {
          const err = await res.json();
          alert('Erreur : ' + err.message);
        }
      } catch (err) {
        console.error(err);
        alert("Erreur réseau lors de l'envoi.");
      }
    }

    // Déconnexion
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('userType');
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>
