<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Examen √âtudiant</title>
  <link rel="stylesheet" href="style5.css">
  <style>
    #message {
      margin-top: 20px;
      color: red;
    }
    #exam-link-section {
      margin-top: 30px;
    }
    img, video, audio {
      display: block;
      margin-top: 10px;
      max-width: 90%;
    }
  </style>
</head>
<body>
  <h1>Examen</h1>

  <div id="exam-link-section">
    <p>Entrez le lien ou code d'examen :</p>
    <input type="text" id="examLinkInput" placeholder="ex : http://localhost:5000/exam/ma8q1r9n ou juste le code">
    <button onclick="demarrerExamen()">Commencer l'examen</button>
  </div>

  <div id="message"></div>

  <script>
    const token = localStorage.getItem('token');
    const userType = localStorage.getItem('userType');

    if (!token || userType !== 'Etudiant') {
      alert('Acc√®s r√©serv√© aux √©tudiants connect√©s.');
      window.location.href = 'login.html';
    }

    async function demarrerExamen() {
      const input = document.getElementById('examLinkInput').value.trim();
      if (!input) {
        alert('Veuillez entrer un lien ou un code d\'examen.');
        return;
      }

      let code;
      if (input.startsWith('http')) {
        const parts = input.split('/');
        code = parts[parts.length - 1];
      } else {
        code = input;
      }

      try {
        const examResponse = await fetch(`http://localhost:5000/api/exams/code/${code}`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!examResponse.ok) throw new Error('Examen introuvable.');
        const exam = await examResponse.json();
        const examId = exam._id;

        if (!navigator.geolocation) {
          document.getElementById('message').textContent = "La g√©olocalisation n'est pas support√©e par ce navigateur.";
          return;
        }

        navigator.geolocation.getCurrentPosition(async (position) => {
          const latitude = position.coords.latitude;
          const longitude = position.coords.longitude;

          const token = localStorage.getItem('token'); // r√©cup√®re le token JWT
          console.log('Token JWT envoy√© :', token);

          const geoRes = await fetch(`http://localhost:5000/api/exams/geolocalisation`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body : JSON.stringify({
              examId: examId,
              latitude: latitude,
              longitude: longitude
            })
          });

          if (!geoRes.ok) throw new Error("Erreur lors de l'envoi des coordonn√©es.");

          document.getElementById('message').style.color = 'green';
          document.getElementById('message').textContent = "G√©olocalisation enregistr√©e avec succ√®s. Pr√™t pour la suite.";

          const questionsRes = await fetch(`http://localhost:5000/api/questions/exam/${examId}`, {
            headers: { Authorization: `Bearer ${token}` }
          });

          if (!questionsRes.ok) throw new Error("Impossible de r√©cup√©rer les questions.");
          const questions = await questionsRes.json();

          window.questions = questions;
          demarrerAffichageQuestions(questions, examId);

        }, (error) => {
          document.getElementById('message').textContent = "G√©olocalisation refus√©e ou erreur : " + error.message;
        });

      } catch (err) {
        document.getElementById('message').style.color = 'red';
        document.getElementById('message').textContent = "Erreur : " + err.message;
      }
    }

    let currentIndex = 0;
    const reponsesEtudiant = [];

    function demarrerAffichageQuestions(questions, examId) {
      document.body.innerHTML = ''; // Nettoyer tout
      const questionDiv = document.createElement('div');
      questionDiv.id = 'questionContainer';
      document.body.appendChild(questionDiv);
      afficherQuestion(questions, questionDiv, examId);
    }

    function afficherQuestion(questions, container, examId) {
      if (currentIndex >= questions.length) {
        fetch('http://localhost:5000/api/exams/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            examId,
            reponses: reponsesEtudiant
          })
        }).then(() => {
          window.location.href = 'score.html';
        }).catch(() => {
          alert("Erreur lors de l'envoi des r√©ponses.");
        });
        return;
      }

      const question = questions[currentIndex];
      container.innerHTML = '';

      const questionTitle = document.createElement('h2');
      questionTitle.textContent = `Question ${currentIndex + 1}: ${question.enonce}`;
      container.appendChild(questionTitle);

      // üîπ Affichage image
      if (question.media) {
        const extension = question.media.split('.').pop().toLowerCase();

        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
          const img = document.createElement('img');
          img.src = `http://localhost:5000/${question.media}`;
          img.alt = 'Illustration';
          container.appendChild(img);
        } else if (['mp3', 'wav', 'ogg'].includes(extension)) {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = `http://localhost:5000/${question.media}`;
          container.appendChild(audio);
        } else if (['mp4', 'webm', 'ogg'].includes(extension)) {
          const video = document.createElement('video');
          video.controls = true;
          video.src = `http://localhost:5000/${question.media}`;
          container.appendChild(video);
        }
      }


      if (question.type === 'qcm') {
        question.options.forEach(choix => {
          const label = document.createElement('label');
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'reponse';
          radio.value = choix;
          label.appendChild(radio);
          label.appendChild(document.createTextNode(choix));
          container.appendChild(label);
          container.appendChild(document.createElement('br'));
        });
      } else {
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'reponseDirecte';
        container.appendChild(input);
      }

      const duree = question.duree || 10;
      let tempsRestant = duree;
      const timerElement = document.createElement('p');
      timerElement.style.color = 'blue';
      container.appendChild(timerElement);

      const interval = setInterval(() => {
        timerElement.textContent = `Temps restant : ${tempsRestant} sec`;
        tempsRestant--;
        if (tempsRestant < 0) {
          clearInterval(interval);
          enregistrerEtAfficherSuivante(question, questions, container, examId);
        }
      }, 1000);

      const boutonSuivant = document.createElement('button');
      boutonSuivant.textContent = "Suivant";
      boutonSuivant.onclick = () => {
        clearInterval(interval);
        enregistrerEtAfficherSuivante(question, questions, container, examId);
      };
      container.appendChild(boutonSuivant);
    }

    function enregistrerEtAfficherSuivante(question, questions, container, examId) {
      let reponse;
      if (question.type === 'qcm') {
        const checked = document.querySelector('input[name="reponse"]:checked');
        reponse = checked ? checked.value : null;
      } else {
        const input = document.getElementById('reponseDirecte');
        reponse = input ? input.value.trim() : '';
      }

      reponsesEtudiant.push({
        questionId: question._id,
        reponse
      });

      // üõ†Ô∏è üî• Ajoute la soumission au serveur
      fetch('http://localhost:5000/api/exams/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          examId: examId,
          reponses: reponsesEtudiant
        })
      }).then(response => response.json())
        .then(data => console.log("‚úÖ R√©ponse enregistr√©e :", data))
        .catch(error => console.error("‚ùå Erreur lors de la soumission :", error));

      currentIndex++;
      afficherQuestion(questions, container, examId);
    }
  </script>
</body>
</html>