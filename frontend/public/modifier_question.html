<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifier une question</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #e0f7fa, #fce4ec);
      min-height: 100vh;
      padding: 30px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #34495e;
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .options-container {
      margin-top: 15px;
    }

    .option-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .option-item input[type="text"] {
      flex-grow: 1;
      margin-right: 10px;
    }

    .option-item input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 8px;
    }

    .btn-add-option {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 15px;
      transition: background-color 0.3s, transform 0.2s;
    }

    .btn-add-option:hover {
      background-color: #27ae60;
      transform: translateY(-2px);
    }

    .btn-remove {
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .btn-remove:hover {
      background-color: #c0392b;
    }

    .buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
    }

    .btn-primary {
      background-color: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-secondary {
      background-color: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #7f8c8d;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(149, 165, 166, 0.3);
    }

    .preview-container {
      margin-top: 20px;
    }

    .preview-container img,
    .preview-container video,
    .preview-container audio {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }

    .current-media {
      margin-top: 10px;
      padding: 10px;
      background-color: #f2f2f2;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .current-media img,
    .current-media video,
    .current-media audio {
      max-width: 300px;
      max-height: 200px;
      margin-bottom: 10px;
    }

    .hidden {
      display: none;
    }

    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 5px;
    }

    .success-message {
      color: #2ecc71;
      font-size: 16px;
      margin-top: 20px;
      text-align: center;
      padding: 10px;
      background-color: rgba(46, 204, 113, 0.1);
      border-radius: 8px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-type-toggle {
      display: flex;
      margin-bottom: 20px;
      background-color: #f2f2f2;
      border-radius: 8px;
      overflow: hidden;
    }

    .form-type-toggle label {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-bottom: 0;
    }

    .form-type-toggle input[type="radio"] {
      display: none;
    }

    .form-type-toggle input[type="radio"]:checked + label {
      background-color: #3498db;
      color: white;
    }

    .status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }

    .status-message.success {
      background-color: rgba(46, 204, 113, 0.2);
      color: #27ae60;
    }

    .status-message.error {
      background-color: rgba(231, 76, 60, 0.2);
      color: #c0392b;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Modifier la question</h1>
    
    <form id="questionForm">
      <!-- Champ caché pour l'ID de la question -->
      <input type="hidden" id="questionId" name="questionId">
      <!-- Champ caché pour l'ID de l'examen -->
      <input type="hidden" id="examId" name="examId">

      <div class="form-group">
        <label for="type">Type de question</label>
        <select id="type" name="type" required>
          <option value="qcm">QCM</option>
          <option value="directe">Question directe</option>
        </select>
      </div>

      <div class="form-group">
        <label for="enonce">Énoncé de la question</label>
        <textarea id="enonce" name="enonce" required></textarea>
      </div>

      <div class="form-group">
        <label for="note">Note (points)</label>
        <input type="number" id="note" name="note" min="0" step="0.5" required>
      </div>

      <div class="form-group">
        <label for="duree">Durée (en secondes)</label>
        <input type="number" id="duree" name="duree" min="1" required>
      </div>

      <!-- Section média actuel -->
      <div class="form-group">
        <label>Média actuel</label>
        <div id="currentMedia" class="current-media">
          <p>Aucun média</p>
        </div>
      </div>

      <div class="form-group">
        <label for="media">Changer le média (optionnel)</label>
        <input type="file" id="media" name="media" accept="image/*,video/*,audio/*">
        <div id="mediaPreview" class="preview-container"></div>
      </div>

      <!-- Section pour QCM -->
      <div id="qcmSection">
        <div class="form-group">
          <label>Options et réponses correctes</label>
          <button type="button" id="addOption" class="btn-add-option">+ Ajouter une option</button>
          <div id="optionsContainer" class="options-container"></div>
        </div>
      </div>

      <!-- Section pour question directe -->
      <div id="directeSection" class="hidden">
        <div class="form-group">
          <label for="reponseDirecte">Réponse correcte</label>
          <input type="text" id="reponseDirecte" name="reponseDirecte">
        </div>

        <div class="form-group">
          <label for="tolerance">Tolérance (distance de Levenshtein)</label>
          <input type="number" id="tolerance" name="tolerance" min="0" value="0">
          <small>0 = correspondance exacte, 1 = tolère une lettre différente, etc.</small>
        </div>
      </div>

      <div id="statusMessage" class="status-message hidden"></div>

      <div class="buttons">
        <button type="button" class="btn btn-secondary" id="btnRetour">Retour</button>
        <button type="submit" class="btn btn-primary" id="btnSave">
          Enregistrer les modifications
          <span id="loadingSpinner" class="loading hidden"></span>
        </button>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Récupérer les paramètres de l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const questionId = urlParams.get('id');
      const examId = urlParams.get('examId');
      
      if (!questionId || !examId) {
        showStatusMessage('Paramètres manquants dans l\'URL', 'error');
        return;
      }

      // Définir les champs cachés
      document.getElementById('questionId').value = questionId;
      document.getElementById('examId').value = examId;

      // Variables globales pour stocker les données de la question
      let questionData = null;
      
      // Chargement initial des données de la question
      try {
        showLoading(true);
        const response = await fetch(`http://localhost:5000/api/questions/question/${questionId}`);
        if (!response.ok) {
          throw new Error('Erreur lors de la récupération de la question');
        }
        
        questionData = await response.json();
        console.log('Question récupérée:', questionData);
        
        // Remplir le formulaire avec les données récupérées
        fillFormWithQuestionData(questionData);
        showLoading(false);
      } catch (error) {
        console.error('Erreur:', error);
        showStatusMessage('Erreur lors du chargement de la question', 'error');
        showLoading(false);
      }

      // Fonction pour remplir le formulaire avec les données de la question
      function fillFormWithQuestionData(data) {
        document.getElementById('type').value = data.type;
        document.getElementById('enonce').value = data.enonce;
        document.getElementById('note').value = data.note;
        document.getElementById('duree').value = data.duree;

        // Gestion du média
        if (data.media) {
          const mediaUrl = `http://localhost:5000/${data.media}`;
          const fileExtension = data.media.split('.').pop().toLowerCase();
          const mediaContainer = document.getElementById('currentMedia');
          
          mediaContainer.innerHTML = ''; // Vider le conteneur

          if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
            const img = document.createElement('img');
            img.src = mediaUrl;
            img.alt = "Image actuelle";
            mediaContainer.appendChild(img);
          } else if (['mp4', 'webm'].includes(fileExtension)) {
            const video = document.createElement('video');
            video.controls = true;
            video.src = mediaUrl;
            mediaContainer.appendChild(video);
          } else if (['mp3', 'wav', 'ogg'].includes(fileExtension)) {
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = mediaUrl;
            mediaContainer.appendChild(audio);
          }

          const mediaInfo = document.createElement('p');
          mediaInfo.textContent = `Fichier actuel: ${data.media.split('/').pop()}`;
          mediaContainer.appendChild(mediaInfo);
        } else {
          document.getElementById('currentMedia').innerHTML = '<p>Aucun média</p>';
        }

        // Afficher la section appropriée selon le type de question
        if (data.type === 'qcm') {
          document.getElementById('qcmSection').classList.remove('hidden');
          document.getElementById('directeSection').classList.add('hidden');
          
          // Remplir les options pour QCM
          const optionsContainer = document.getElementById('optionsContainer');
          optionsContainer.innerHTML = ''; // Vider le conteneur d'options
          
          if (data.options && data.options.length > 0) {
            data.options.forEach((option, index) => {
              const isCorrect = data.bonnesReponses && data.bonnesReponses.includes(index);
              addOptionToForm(option, isCorrect);
            });
          } else {
            // Ajouter au moins une option vide
            addOptionToForm('', false);
          }
        } else {
          document.getElementById('qcmSection').classList.add('hidden');
          document.getElementById('directeSection').classList.remove('hidden');
          
          // Remplir les champs pour question directe
          document.getElementById('reponseDirecte').value = data.reponseDirecte || '';
          document.getElementById('tolerance').value = data.tolerance || 0;
        }
      }

      // Fonction pour ajouter une option au formulaire QCM
      function addOptionToForm(optionText = '', isCorrect = false) {
        const optionsContainer = document.getElementById('optionsContainer');
        const optionItem = document.createElement('div');
        optionItem.className = 'option-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = isCorrect;
        checkbox.name = 'correctOption';
        
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.value = optionText;
        textInput.placeholder = 'Option de réponse';
        textInput.required = true;
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-remove';
        removeBtn.textContent = 'X';
        removeBtn.onclick = function() {
          optionsContainer.removeChild(optionItem);
        };
        
        optionItem.appendChild(checkbox);
        optionItem.appendChild(textInput);
        optionItem.appendChild(removeBtn);
        
        optionsContainer.appendChild(optionItem);
      }

      // Écouteur pour le changement de type de question
      document.getElementById('type').addEventListener('change', function() {
        if (this.value === 'qcm') {
          document.getElementById('qcmSection').classList.remove('hidden');
          document.getElementById('directeSection').classList.add('hidden');
        } else {
          document.getElementById('qcmSection').classList.add('hidden');
          document.getElementById('directeSection').classList.remove('hidden');
        }
      });

      // Écouteur pour le bouton d'ajout d'option
      document.getElementById('addOption').addEventListener('click', function() {
        addOptionToForm();
      });

      // Prévisualisation du média
      document.getElementById('media').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const previewContainer = document.getElementById('mediaPreview');
        previewContainer.innerHTML = '';

        const fileReader = new FileReader();
        fileReader.onload = function(event) {
          const fileType = file.type.split('/')[0];
          
          if (fileType === 'image') {
            const img = document.createElement('img');
            img.src = event.target.result;
            previewContainer.appendChild(img);
          } else if (fileType === 'video') {
            const video = document.createElement('video');
            video.controls = true;
            video.src = event.target.result;
            previewContainer.appendChild(video);
          } else if (fileType === 'audio') {
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = event.target.result;
            previewContainer.appendChild(audio);
          }
        };
        
        fileReader.readAsDataURL(file);
      });

      // Écouteur pour le bouton de retour
      document.getElementById('btnRetour').addEventListener('click', function() {
        // Rediriger vers la page des questions de l'examen
        window.location.href = `/exam/${getExamCode(examId)}`;
      });

      // Fonction utilitaire pour extraire le code d'examen de l'ID
      function getExamCode(examId) {
        // Si examId est un code, le retourner directement
        if (examId.length < 24) return examId;
        
        // Sinon, on pourrait avoir besoin d'une logique supplémentaire
        // Mais dans ce cas, on retourne simplement l'examId, et le backend
        // s'occupera de retrouver le bon examen
        return examId;
      }

      // Soumission du formulaire
      document.getElementById('questionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
          showLoading(true);
          
          // Créer un FormData pour envoyer les données + fichier
          const formData = new FormData();
          
          // Ajout des champs de base
          formData.append('examId', document.getElementById('examId').value);
          formData.append('type', document.getElementById('type').value);
          formData.append('enonce', document.getElementById('enonce').value);
          formData.append('note', document.getElementById('note').value);
          formData.append('duree', document.getElementById('duree').value);
          
          // Ajouter le fichier média s'il est fourni
          const mediaInput = document.getElementById('media');
          if (mediaInput.files.length > 0) {
            formData.append('media', mediaInput.files[0]);
          }
          
          // Traitement selon le type de question
          if (document.getElementById('type').value === 'qcm') {
            // Récupérer les options et les réponses correctes pour QCM
            const optionItems = document.querySelectorAll('.option-item');
            const options = [];
            const bonnesReponses = [];
            
            optionItems.forEach((item, index) => {
              const optionText = item.querySelector('input[type="text"]').value;
              const isCorrect = item.querySelector('input[type="checkbox"]').checked;
              
              options.push(optionText);
              if (isCorrect) {
                bonnesReponses.push(index);
              }
            });
            
            formData.append('options', JSON.stringify(options));
            formData.append('bonnesReponses', JSON.stringify(bonnesReponses));
          } else {
            // Ajouter les champs pour question directe
            formData.append('reponse', document.getElementById('reponseDirecte').value);
            formData.append('tolerance', document.getElementById('tolerance').value);
          }
          
          // Envoyer la requête de mise à jour
          const response = await fetch(`http://localhost:5000/api/questions/${questionId}`, {
            method: 'PUT',
            body: formData
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.message || 'Erreur lors de la mise à jour');
          }
          
          showStatusMessage('Question mise à jour avec succès!', 'success');
          
          // Recharger les données après mise à jour
          setTimeout(() => {
            window.location.reload();
          }, 1500);
          
        } catch (error) {
          console.error('Erreur:', error);
          showStatusMessage(`Erreur: ${error.message}`, 'error');
        } finally {
          showLoading(false);
        }
      });

      // Fonctions utilitaires
      function showStatusMessage(message, type) {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        statusEl.className = `status-message ${type}`;
        statusEl.classList.remove('hidden');
        
        // Faire défiler jusqu'au message
        statusEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function showLoading(isLoading) {
        const spinner = document.getElementById('loadingSpinner');
        const saveBtn = document.getElementById('btnSave');
        
        if (isLoading) {
          spinner.classList.remove('hidden');
          saveBtn.disabled = true;
        } else {
          spinner.classList.add('hidden');
          saveBtn.disabled = false;
        }
      }
    });
  </script>
</body>
</html>