<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Questions QCM et Directe de l'examen</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f9f9f9;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
    }

    .question {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }

    .question h3 {
      color: #34495e;
    }

    .question img,
    .question video {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
      border-radius: 8px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .question ul {
      list-style-type: none;
      padding-left: 0;
      margin-top: 15px;
    }

    .question li {
      background-color: #ecf0f1;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      color: #2c3e50;
      font-size: 16px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
    }   

    .modal-content {
      display: block;
      margin: 5% auto;
      max-width: 90%;
      max-height: 80vh;
    } 

    .modal-close {
      color: white;
      position: absolute;
      top: 20px;
      right: 40px;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Questions QCM et Directe de l'examen</h1>
  <div id="questions-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
  try {
    let examId = null;
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('examId')) {
      examId = urlParams.get('examId');
    } else {
      const code = window.location.pathname.split('/').pop();
      examId = code;
      const res = await fetch(`http://localhost:5000/api/exams`);
      const exams = await res.json();
      const matched = exams.find(e => e.lienAcces.endsWith(code));
      if (matched) examId = matched._id;
    }

    if (!examId || examId.includes('.html') || examId.length < 24) {
      console.error("Erreur : examId est invalide ! Valeur re√ßue :", examId);
      document.body.innerHTML = "<h2>Examen introuvable</h2>";
      return;
    }



    const res = await fetch(`http://localhost:5000/api/questions/exam/${examId}`);
    if (!res.ok) throw new Error("Erreur lors de la r√©cup√©ration des questions");

    const questions = await res.json();
    console.log("Questions r√©cup√©r√©es :", questions);

    const container = document.getElementById('questions-container');

    if (!questions.length) {
      container.innerHTML = "<p>Aucune question trouv√©e pour cet examen.</p>";
      return;
    }

    questions.forEach(q => {
      const div = document.createElement('div');
      div.className = 'question';

      const h3 = document.createElement('h3');
      h3.textContent = q.enonce;
      div.appendChild(h3);

      // Affichage du m√©dia si disponible
      if (q.media) {
        const ext = q.media.split('.').pop().toLowerCase();
        const mediaUrl = `http://localhost:5000/${q.media}`;

        if (['png', 'jpg', 'jpeg', 'gif'].includes(ext)) {
          const img = document.createElement('img');
          img.src = mediaUrl;
          img.alt = "media";
          img.style.maxWidth = "300px";
          img.style.cursor = "pointer";
          img.onclick = () => {
            document.getElementById('imgPreview').src = mediaUrl;
            document.getElementById('imgModal').style.display = 'block';
          };
          div.appendChild(img);
        } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = mediaUrl;
          div.appendChild(audio);
        } else if (['mp4', 'webm'].includes(ext)) {
          const video = document.createElement('video');
          video.controls = true;
          video.width = 300;
          const source = document.createElement('source');
          source.src = mediaUrl;
          source.type = `video/${ext}`;
          video.appendChild(source);
          div.appendChild(video);
        }
      }

      // Affichage des questions selon le type
      if (q.type.toLowerCase() === 'qcm') {
        const ul = document.createElement('ul');
        if (Array.isArray(q.options) && q.options.length) {
          q.options.forEach(opt => {
            const li = document.createElement('li');
            li.textContent = opt;
            ul.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = "Aucune option disponible";
          ul.appendChild(li);
        }
        div.appendChild(ul);
      } else if (q.type.toLowerCase() === 'directe') {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = "Votre r√©ponse ici...";
        input.style.width = "100%";
        input.style.padding = "10px";
        input.style.marginTop = "10px";
        input.style.borderRadius = "5px";
        input.style.border = "1px solid #ccc";
        div.appendChild(input);
      }

      const p = document.createElement('p');
      p.innerHTML = `<strong>Note :</strong> ${q.note ?? 'Non sp√©cifi√©e'} | <strong>Dur√©e :</strong> ${q.duree ?? 'Non sp√©cifi√©e'} min`;
      div.appendChild(p);

      // üîß Boutons Modifier et Supprimer
      const btns = document.createElement('div');
      btns.style.marginTop = '15px';

      const btnModifier = document.createElement('button');
      btnModifier.textContent = 'Modifier';
      btnModifier.style.marginRight = '10px';
      btnModifier.onclick = () => {
        window.location.href = `modifier_question.html?id=${q._id}`;
      };

      const btnSupprimer = document.createElement('button');
      btnSupprimer.textContent = 'Supprimer';
      btnSupprimer.style.backgroundColor = '#e74c3c';
      btnSupprimer.style.color = 'white';
      btnSupprimer.onclick = async () => {
        if (confirm('Voulez-vous vraiment supprimer cette question ?')) {
          const delRes = await fetch(`http://localhost:5000/api/questions/${q._id}`, { method: 'DELETE' });
          if (delRes.ok) {
            alert('Question supprim√©e');
            window.location.reload();
          } else {
            alert('Erreur lors de la suppression');
          }
        }
      };

      btns.appendChild(btnModifier);
      btns.appendChild(btnSupprimer);
      div.appendChild(btns);

      container.appendChild(div);
    });

  } catch (err) {
    console.error("Erreur :", err);
    document.body.innerHTML = "<h2>Une erreur est survenue lors du chargement des questions.</h2>";
  }
});
  </script>

  <div id="imgModal" class="modal">
    <span class="modal-close" onclick="document.getElementById('imgModal').style.display='none'">&times;</span>
    <img class="modal-content" id="imgPreview">
  </div>  
</body>
</html>